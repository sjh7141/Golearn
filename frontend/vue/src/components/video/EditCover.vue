<template>
	<v-row id="edit-cover" class="ml-3 height-100">
		<v-col cols="9">
			<h2>ì˜ìƒ</h2>
			<h4 class="pb-5 pl-3" style="color:gray;">
				"ë™ì˜ìƒ íŒŒì¼ê³¼ ì˜ìƒì— ì‚¬ìš©ë  ì¸ë„¤ì¼ì„ ë“±ë¡í•´ì£¼ì„¸ìš”."
			</h4>
			<div justify="center" class="mt-5">
				<div class="pa-6 mb-6 bg-light-gray border-radius-10">
					<div class="bold">
						ì£¼ì˜ì‚¬í•­
					</div>
					<ol>
						<li>
							ë™ì˜ìƒ íŒŒì¼ì˜ ê²½ìš°
							<span class="bold">mp4</span>íŒŒì¼ì´ ê¶Œì¥ë˜ë©° ì´ì™¸ì˜
							íŒŒì¼ì€ ì •ìƒì ìœ¼ë¡œ ì‘ë™ë˜ì§€ì•Šì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
						</li>
						<li>
							íŒŒì¼ ìš©ëŸ‰ì€
							<span class="bold">ìµœëŒ€ 10GB ì´í•˜</span>, ì˜ìƒì˜
							ì¬ìƒì‹œê°„ì€
							<span class="bold">ìµœëŒ€ 8ì‹œê°„ ì´í•˜</span>ë¥¼
							ê¶Œì¥ë“œë¦½ë‹ˆë‹¤.
						</li>
						<li>
							ì»¤ë²„ ì´ë¯¸ì§€(ì¸ë„¤ì¼)ë¥¼ ì§ì ‘ ì œì‘í•˜ì‹¤ ê²½ìš°,
							<span class="bold">768 Ã— 500(px)</span>ì—
							ë§ì¶°ì£¼ì„¸ìš”. ê°€ë¡œí˜• ì´ë¯¸ì§€ì— ìµœì í™”ë˜ì–´ìˆìŠµë‹ˆë‹¤.
						</li>
						<li>
							ì´ë¯¸ì§€ê°€ ê·œì •ì— ë§ì§€ ì•Šì„ ê²½ìš°, ê´€ë¦¬ì íŒë‹¨í•˜ì—
							ì„ì˜ë¡œ ë³€ê²½ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
						</li>
						<li>
							ì´ë¯¸ì§€ëŠ”
							<span class="bold">jpg, jpeg, png</span>íŒŒì¼ë§Œ ì‚¬ìš©
							ê°€ëŠ¥í•©ë‹ˆë‹¤.
						</li>
					</ol>
				</div>
				<div>
					<div class="bold">ì˜ìƒ</div>
					<div class="pb-8" style="text-align:end;">
						<v-btn
							outlined
							class="add-btn mr-3"
							@click="clickVideo"
						>
							<v-icon color="darken-3">
								mdi-plus
							</v-icon>
							<span style="font-size:15px;">ì—…ë¡œë“œ</span>
						</v-btn>
						<v-btn outlined class="add-btn" @click="isAdd = true">
							<v-icon color="darken-3">
								mdi-plus
							</v-icon>
							<span style="font-size:15px;">ê°€ì ¸ì˜¤ê¸°</span>
						</v-btn>
					</div>
					<v-row class="pb-5">
						<v-col md="8" offset="2">
							<video
								v-show="isVideo"
								controls
								style="width:100%; max-width: 1500px;"
								ref="video"
							>
								ë¸Œë¼ìš°ì €ì—ì„œ ì§€ì›ë˜ëŠ” í¬ë§·ì´ ì•„ë‹™ë‹ˆë‹¤.
							</video>
							<div v-show="!isVideo" class="empty-box">
								ì˜ìƒì—…ë¡œë“œì‹œ ë¯¸ë¦¬ ë³´ê¸°ê°€ ì œê³µë©ë‹ˆë‹¤.ğŸ˜Š
							</div>
						</v-col>
					</v-row>
				</div>
				<div>
					<div class="bold">ì»¤ë²„ ì´ë¯¸ì§€</div>
					<v-row>
						<v-col md="5">
							<v-btn
								v-show="!isImg"
								tile
								class="py-7"
								text
								color="gray"
								id="img-btn"
								@click="clickImg"
							>
								<v-icon class="upload-icon pt-10">
									mdi-image-plus
								</v-icon>
								<div class="pb-4">íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.</div>
							</v-btn>
							<v-hover v-slot="{ hover }">
								<v-card
									class="mx-auto"
									color="grey lighten-4"
									max-width="600"
								>
									<v-img
										v-show="isImg"
										ref="img"
										height="300"
									>
										<v-expand-transition>
											<v-row
												v-if="hover"
												class="d-flex transition-fast-in-fast-out darken-2 v-card--reveal display-3 white--text"
												style="height: 100%; background-color:rgba(0,0,0,0.3);"
												align="center"
												justify="center"
											>
												<v-btn
													fab
													large
													@click="deleteImg"
													color="rgba(255,255,255,0.8)"
												>
													<v-icon
														color="rgba(0,0,0,0.5)"
														large
													>
														mdi-trash-can
													</v-icon>
												</v-btn>
											</v-row>
										</v-expand-transition>
									</v-img>
								</v-card>
							</v-hover>
						</v-col>
						<v-col md="7">
							<div
								class="bg-light-gray border-radius-10 pa-6"
								style="height:100%;"
							>
								<div class="bold">
									ì–´ë–¤ ì´ë¯¸ì§€ë¥¼ ì„ íƒí•˜ì‹¤ì§€ ê³ ë¯¼ì´ì‹ ê°€ìš”?
								</div>
								<br />
								ì˜ìƒì˜ ì²«ì¸ìƒì„ ì±…ì„ì§€ëŠ” ì¸ë„¤ì¼!
								<br />
								ì–´ë–¤ ì´ë¯¸ì§€ê°€ ì¢‹ì„ì§€
								<span>
									<a href="#">
										<span>ì¸ë„¤ì¼ ê°€ì´ë“œ</span>
									</a>
								</span>
								ë¥¼ í™•ì¸í•´ ë³´ì„¸ìš”!
								<v-row>
									<v-col cols="4">
										<v-img
											class="border-radius-10"
											src="https://4.bp.blogspot.com/-FKj4lxWCQrA/U2oVUsAZrVI/AAAAAAAAApA/D0oJ6QP_z0g/s1600/phpCode.png"
											height="115"
										></v-img>
									</v-col>
									<v-col cols="4">
										<v-img
											class="border-radius-10"
											src="@/assets/thumbnail_1.jpg"
											height="115"
										></v-img>
									</v-col>
									<v-col cols="4">
										<v-img
											class="border-radius-10"
											src="@/assets/thumbnail_2.jpg"
											height="115"
										></v-img>
									</v-col>
								</v-row>
							</div>
						</v-col>
					</v-row>
					<input
						ref="videoFile"
						type="file"
						id="videoFile"
						v-show="false"
						accept="video/*"
						@change="setVideo"
					/>
					<input
						ref="file"
						type="file"
						id="file"
						v-show="false"
						accept="image/png, image/jpeg, image/bmp"
						@change="setImg"
					/>
				</div>
			</div>
			<div class="mt-6" style="text-align:end;">
				<v-btn dark color="#5500ff" @click="save" :loading="loading">
					ì €ì¥
				</v-btn>
			</div>
			<v-dialog v-model="isAdd" max-width="600">
				<v-card>
					<v-card-title class="headline pb-6">
						ë³´ê´€í•¨ ëª©ë¡
					</v-card-title>
					<v-card-text>
						<template v-for="(element, index) in videoList">
							<div
								class="mb-2 border-radius-10"
								:key="index + '_vid'"
							>
								<index-video
									:video="element"
									:idx="index"
									:selectVideoNo="selectVideoNo"
									@selectVideo="selectVideo"
								/>
							</div>
						</template>
					</v-card-text>
					<v-card-actions>
						<v-spacer></v-spacer>
						<v-btn
							color="error darken-1"
							text
							@click="isAdd = false"
						>
							<span class="bold" @click="resetVideo">ì·¨ì†Œ</span>
						</v-btn>
						<v-btn color="darken-1" text @click="confirm">
							<span class="bold">í™•ì¸</span>
						</v-btn>
					</v-card-actions>
				</v-card>
			</v-dialog>
		</v-col>
		<v-col cols="3">
			<div>ğŸ’•ì¸ë„¤ì¼ ê³ ë¥´ëŠ” Tip!</div>
		</v-col>
	</v-row>
</template>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
<script>
import IndexVideo from '@/components/course/IndexVideo.vue';
import { mapGetters } from 'vuex';
import getBlobDuration from 'get-blob-duration';

export default {
	components: { IndexVideo },
	data() {
		return {
			isImg: false,
			isNew: false,
			isVideo: false,
			isAdd: false,
			videoList: [],
			connectVideo: null,
			selectVideoNo: -1,
			loading: false,
		};
	},
	methods: {
		setImg() {
			var self = this;
			var file = document.getElementById('file').files[0];
			var reader = new FileReader();

			reader.onloadend = function() {
				self.isImg = true;
				self.$refs.img.src = reader.result;
			};

			if (file) {
				reader.readAsDataURL(file);
			}
		},
		setVideo() {
			var self = this;
			var file = document.getElementById('videoFile').files[0];
			var reader = new FileReader();

			reader.onloadend = function() {
				self.isVideo = true;
				self.isNew = true;
				self.$refs.video.src = reader.result;
				self.setTotalTime(reader.result);
			};

			if (file) {
				reader.readAsDataURL(file);
			}
		},
		async setTotalTime(src) {
			const duration = await getBlobDuration(src);
			this.$store.commit('setVideoLength', parseInt(duration));
		},
		clickImg() {
			this.$refs.file.value = null;
			$('#file').click();
		},
		clickVideo() {
			this.$refs.videoFile.value = null;
			$('#videoFile').click();
		},
		deleteImg() {
			this.isImg = false;
		},
		selectVideo(idx) {
			this.selectVideoNo = idx;
		},
		resetVideo() {
			this.selectVideoNo = -1;
			this.isAdd = false;
		},
		confirm() {
			if (this.selectVideoNo == -1) {
				alert('ì˜ìƒì„ ì„ íƒí•´ì£¼ì„¸ìš”');
				return;
			}
			this.isVideo = true;
			this.$refs.video.src = this.videoList[this.selectVideoNo].vid_url;
			this.setTotalTime(this.videoList[this.selectVideoNo].vid_url);
			this.connectVideo = this.videoList[this.selectVideoNo];
			this.isNew = false;
			this.resetVideo();
		},
		async save() {
			if (!this.isVideo) {
				alert('ì˜ìƒì„ ì—…ë¡œë“œ ë˜ëŠ” ë³´ê´€í•¨ì—ì„œ ì„ íƒí•´ì£¼ì„¸ìš”');
				return;
			}
			this.loading = true;
			var thumbnailURL = await this.saveThumbnail();
			var videoURL = this.isNew
				? await this.saveVideo()
				: this.connectVideo.vid_url;
			this.loading = false;
			if (thumbnailURL) {
				this.$store.commit('setThumbnailURL', thumbnailURL.data);
			}
			if (videoURL) {
				this.$store.commit('setVideoURL', videoURL.data);
			}
			this.$emit('changeActive', 0);
		},
		saveThumbnail() {
			let formData = new FormData();
			if (document.getElementById('file').files[0]) {
				formData.append(
					'file',
					document.getElementById('file').files[0],
				);
				return this.$store.dispatch('upload', {
					data: formData,
					target: 'video/thumbnail',
				});
			}
		},
		saveVideo() {
			let formData = new FormData();
			if (document.getElementById('videoFile').files[0]) {
				formData.append(
					'file',
					document.getElementById('videoFile').files[0],
				);
				return this.$store.dispatch('upload', {
					data: formData,
					target: 'video',
				});
			}
		},
	},
	mounted() {
		this.$store.dispatch('getSaveVideos').then(({ data }) => {
			for (let video of data) {
				this.$store
					.dispatch('getUserByNo', video.mbr_no)
					.then(({ data }) => {
						video.mbr_nick_name = data.nickname;
						video.mbr_profile = data.profile;
						this.videoList.push(video);
					});
			}
		});
	},
	computed: {
		...mapGetters(['uploadVideo']),
	},
};
</script>

<style scoped>
.label {
	padding-bottom: 8px;
}

.item {
	padding-bottom: 24px;
}

#background-img {
	display: none;
	cursor: pointer;
}

#img-btn {
	width: 100%;
	height: 300px;
	border: 1px solid #c9c9c9;
	border-radius: 10px;
	cursor: pointer;
	font-weight: 600;
	font-size: 14px;
	text-align: center;
}

#banner-btn {
	width: 100%;
	height: 100%;
	border: 1px solid #c9c9c9;
	border-radius: 10px;
	cursor: pointer;
	font-weight: 600;
	font-size: 14px;
	text-align: center;
}

.upload-icon {
	font-size: 30px;
	color: black;
}

a {
	text-decoration: none;
}

.add-btn {
	border: 1px solid #c9c9c9;
	font-weight: 600;
}

.empty-box {
	font-size: 30px;
	font-weight: 600;
	color: #b5b5b5;
	text-align: center;
	min-height: 100px;
}
</style>

<style>
#edit-cover .v-btn__content {
	display: inline-block !important;
	text-align: center;
	margin: 0 auto;
}
</style>
